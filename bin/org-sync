#!/usr/bin/env ruby
#
# "Sync" to MobileOrg by rebuilding the index and checksums data. This
# pretty much only needs to be run when a file is created or removed.

ORG_PATH = ENV['ORG_PATH']

File.open "#{ORG_PATH}/index.org", 'w+' do |f|
  f.puts %(#+READONLY
#+TODO: TODO DONE
#+TODO:  | DONE
#+TAGS:
#+DRAWERS: PROPERTIES CLOCK LOGBOOK RESULTS
#+ALLPRIORITIES: A B C
  )
  Dir["#{ORG_PATH}/**/*.org"].reject do |path|
    path =~ /(index|mobileorg)\.org/
  end.each do |path|
    base = File.basename path
    name = base.gsub(/\.org/, '').capitalize
    f.puts "[[file:#{base}|#{name}]]"
  end
end

# Write checksums file
File.write "#{ORG_PATH}/checksums.dat", `shasum #{ORG_PATH}/**/*.org 2>/dev/null`
